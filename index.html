<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI èªéŸ³å£èªªæ•™ç·´</title>
    <style>
        :root {
            --primary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
        }

        body {
            font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            background-color: #f4f6f7;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* éŠæˆ²å®¹å™¨ */
        .game-card {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 40px;
            text-align: center;
            position: relative;
        }

        h1 { margin-top: 0; color: #333; font-size: 1.5em;}
        
        /* é¡Œç›®é¡¯ç¤ºå€ (è‹±æ–‡) */
        .question-box {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .hint { color: #7f8c8d; font-size: 1em; margin-bottom: 30px; }

        /* éº¥å…‹é¢¨æŒ‰éˆ• */
        .mic-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            outline: none;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
            transition: all 0.3s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn svg {
            width: 50px;
            height: 50px;
            fill: white;
        }

        .mic-btn.listening {
            background: var(--accent);
            animation: pulse 1.5s infinite;
        }

        /* è¾¨è­˜çµæœé¡¯ç¤º */
        .result-text {
            margin-top: 20px;
            font-size: 1.5em;
            min-height: 1.5em;
            color: #555;
            font-weight: bold;
        }

        .status-msg {
            margin-top: 10px;
            font-size: 0.9em;
            color: #aaa;
        }

        /* ç­”å°/ç­”éŒ¯å‹•ç•« */
        .feedback-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5em;
            color: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .correct .feedback-overlay {
            background: rgba(46, 204, 113, 0.9);
            opacity: 1;
            z-index: 10;
        }
        
        .wrong .feedback-overlay {
            background: rgba(231, 76, 60, 0.9);
            opacity: 1;
            z-index: 10;
        }

        /* é€²åº¦æ¢ */
        .progress-container {
            width: 100%;
            background: #eee;
            height: 6px;
            border-radius: 3px;
            margin-top: 30px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.5s;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

    </style>
</head>
<body>

    <div class="game-card" id="card-area">
        <h1>ğŸ—£ï¸ å£èªªæŒ‘æˆ° (Speak Up)</h1>
        
        <div class="question-box" id="question-display">Ready?</div>
        <div class="hint">è«‹èªªå‡ºä¸Šåˆ—å–®å­—çš„<b>ä¸­æ–‡</b></div>

        <div style="display:flex; justify-content:center;">
            <button class="mic-btn" id="mic-btn" onclick="toggleListening()">
                <svg viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            </button>
        </div>

        <div class="result-text" id="transcript-display">...</div>
        <div class="status-msg" id="status-display">é»æ“Šéº¥å…‹é¢¨é–‹å§‹</div>

        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="feedback-overlay" id="feedback-icon"></div>
    </div>

    <script src="words.js"></script>

    <script>
        // --- æª¢æŸ¥ç€è¦½å™¨æ”¯æ´ ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜åŠŸèƒ½ã€‚è«‹ä½¿ç”¨ Google Chrome æˆ– Microsoft Edgeã€‚");
        }

        // --- è®Šæ•¸è¨­å®š ---
        let recognition;
        let isListening = false;
        let currentWordObj = null;
        let queue = [];
        let score = 0;
        let total = 0;

        // DOM
        const micBtn = document.getElementById('mic-btn');
        const questionDisplay = document.getElementById('question-display');
        const transcriptDisplay = document.getElementById('transcript-display');
        const statusDisplay = document.getElementById('status-display');
        const cardArea = document.getElementById('card-area');
        const feedbackIcon = document.getElementById('feedback-icon');
        const progressBar = document.getElementById('progress-bar');

        if (typeof wordData === 'undefined') {
            alert("æ‰¾ä¸åˆ° words.js");
        }

        // --- åˆå§‹åŒ–èªéŸ³è¾¨è­˜ ---
        function setupRecognition() {
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW'; // è¨­å®šè¾¨è­˜èªè¨€ç‚ºç¹é«”ä¸­æ–‡
            recognition.interimResults = false; // ä¸éœ€è¦å³æ™‚é¡¯ç¤ºï¼Œç­‰è¬›å®Œå†é¡¯ç¤º
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                isListening = true;
                micBtn.classList.add('listening');
                statusDisplay.textContent = "æ­£åœ¨è†è½...è«‹èªªä¸­æ–‡";
                transcriptDisplay.textContent = "...";
            };

            recognition.onend = function() {
                isListening = false;
                micBtn.classList.remove('listening');
                // å¦‚æœä¸æ˜¯æ‰‹å‹•åœæ­¢ï¼Œä¸”é‚„æ²’åˆ¤æ–·å‡ºçµæœï¼Œæ¢å¾©æç¤º
                if (statusDisplay.textContent.includes("è†è½")) {
                     statusDisplay.textContent = "é»æ“Šéº¥å…‹é¢¨é‡è©¦";
                }
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;
                
                transcriptDisplay.textContent = `"${transcript}"`;
                checkAnswer(transcript);
            };

            recognition.onerror = function(event) {
                statusDisplay.textContent = "ç™¼ç”ŸéŒ¯èª¤: " + event.error;
                micBtn.classList.remove('listening');
                isListening = false;
            };
        }

        // --- éŠæˆ²é‚è¼¯ ---
        function initGame() {
            if (SpeechRecognition) setupRecognition();
            queue = [...wordData].sort(() => 0.5 - Math.random()); // æ´—ç‰Œ
            total = queue.length;
            nextQuestion();
        }

        function nextQuestion() {
            if (queue.length === 0) {
                questionDisplay.textContent = "å®Œæˆï¼";
                statusDisplay.textContent = "æ‰€æœ‰å–®å­—ç·´ç¿’å®Œç•¢";
                transcriptDisplay.textContent = "";
                micBtn.style.display = 'none';
                return;
            }

            currentWordObj = queue.pop();
            // é¡¯ç¤ºè‹±æ–‡æ„æ€
            questionDisplay.textContent = currentWordObj.meaning;
            transcriptDisplay.textContent = "...";
            statusDisplay.textContent = "é»æ“Šéº¥å…‹é¢¨å›ç­”";
            
            // æ›´æ–°é€²åº¦æ¢
            let progress = ((total - queue.length) / total) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function toggleListening() {
            if (!SpeechRecognition) return;

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function checkAnswer(userSaid) {
            // ç§»é™¤æ¨™é»ç¬¦è™Ÿèˆ‡ç©ºç™½ï¼Œç¢ºä¿æ¯”å°æº–ç¢º
            let cleanUser = userSaid.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, "");
            let cleanTarget = currentWordObj.word.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, "");

            // æ¨¡ç³Šæ¯”å° (å¦‚æœä½¿ç”¨è€…èªªçš„åŒ…å«ç›®æ¨™å­—ï¼Œæˆ–æ˜¯ç›®æ¨™å­—åŒ…å«ä½¿ç”¨è€…èªªçš„)
            // ç‚ºäº†æ›´åš´è¬¹ï¼Œå»ºè­°ç”¨å®Œå…¨æ¯”å°: cleanUser === cleanTarget
            if (cleanUser === cleanTarget || cleanUser.includes(cleanTarget)) {
                // ç­”å°
                showFeedback(true);
                speak("æ­£ç¢º"); // é›»è…¦çµ¦äºˆèªéŸ³å›é¥‹
                setTimeout(nextQuestion, 1500);
            } else {
                // ç­”éŒ¯
                showFeedback(false);
                statusDisplay.textContent = `æ­£ç¢ºæ‡‰è©²æ˜¯: ${currentWordObj.word}`;
                // ä¸åˆ‡æ›ä¸‹ä¸€é¡Œï¼Œè®“å­¸ç”Ÿé‡è©¦
            }
        }

        function showFeedback(isCorrect) {
            cardArea.className = "game-card " + (isCorrect ? "correct" : "wrong");
            feedbackIcon.textContent = isCorrect ? "âœ”" : "âœ˜";
            
            setTimeout(() => {
                cardArea.className = "game-card";
            }, 1000);
        }

        // ç°¡å–®çš„èªéŸ³å›é¥‹
        function speak(text) {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'zh-TW';
                window.speechSynthesis.speak(u);
            }
        }

        // å•Ÿå‹•
        initGame();

    </script>
</body>
</html>